<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Probing and Path Finding | Lightning Dev Kit Documentation</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="preload" href="/fonts/ibm-plex-mono-400.woff2" as="font" crossorigin="true">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/variables.css">
    <link name="msapplication-config" content="/browserconfig.xml">
    <link name="msapplication-TileColor" content="#ffffff">
    <link name="theme-color" content="#ffffff">
    <meta name="description" content="LDK is a flexible lightning implementation with supporting batteries (or modules).">
    <meta property="og:site_name" content="Lightning Dev Kit Documentation">
    <meta property="og:title" content="Probing and Path Finding">
    <meta property="og:description" content="The Lightning Development Kit LDK provides you with the software tools to build a node on the Lightning Network. The Lightning Network is a collection of tens of thousands of nodes that, together, enable cheap and private Bitcoin transactions.">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://lightningdevkit.org/probing/">
    <meta property="og:image" content="https://lightningdevkit.org/card.png">
    <meta name="twitter:title" content="Probing and Path Finding">
    <meta name="twitter:description" content="The Lightning Development Kit LDK provides you with the software tools to build a node on the Lightning Network. The Lightning Network is a collection of tens of thousands of nodes that, together, enable cheap and private Bitcoin transactions.">
    <meta name="twitter:url" content="https://lightningdevkit.org/probing/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://lightningdevkit.org/card.png">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Bitcoin, Lightning, LDK, Lightning Dev Kit, Documentation">
    <meta property="article:tag" content="Bitcoin">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    
    <link rel="preload" href="/assets/css/0.styles.097f5d83.css" as="style"><link rel="preload" href="/assets/js/app.7d2abb65.js" as="script"><link rel="preload" href="/assets/js/10.e6e8a98f.js" as="script"><link rel="preload" href="/assets/js/1.849294d7.js" as="script"><link rel="preload" href="/assets/js/32.148c6653.js" as="script"><link rel="prefetch" href="/assets/js/11.766dbdc2.js"><link rel="prefetch" href="/assets/js/12.5ca28d3f.js"><link rel="prefetch" href="/assets/js/13.244f92a2.js"><link rel="prefetch" href="/assets/js/14.eb2e7658.js"><link rel="prefetch" href="/assets/js/15.d3853dcf.js"><link rel="prefetch" href="/assets/js/16.2a376263.js"><link rel="prefetch" href="/assets/js/17.a14ed725.js"><link rel="prefetch" href="/assets/js/18.9a808b7d.js"><link rel="prefetch" href="/assets/js/19.25b1b007.js"><link rel="prefetch" href="/assets/js/20.17377d70.js"><link rel="prefetch" href="/assets/js/21.8c8f3cf6.js"><link rel="prefetch" href="/assets/js/22.641963cb.js"><link rel="prefetch" href="/assets/js/23.592fcfbb.js"><link rel="prefetch" href="/assets/js/24.83a572ef.js"><link rel="prefetch" href="/assets/js/25.9035b07f.js"><link rel="prefetch" href="/assets/js/26.340c1312.js"><link rel="prefetch" href="/assets/js/27.d9b24174.js"><link rel="prefetch" href="/assets/js/28.798000cb.js"><link rel="prefetch" href="/assets/js/29.a473b983.js"><link rel="prefetch" href="/assets/js/30.20eced78.js"><link rel="prefetch" href="/assets/js/31.3bea1c16.js"><link rel="prefetch" href="/assets/js/33.b903c57b.js"><link rel="prefetch" href="/assets/js/34.e1711435.js"><link rel="prefetch" href="/assets/js/35.8670a9ec.js"><link rel="prefetch" href="/assets/js/36.62205031.js"><link rel="prefetch" href="/assets/js/37.d54d5329.js"><link rel="prefetch" href="/assets/js/38.66628add.js"><link rel="prefetch" href="/assets/js/39.22d98fa0.js"><link rel="prefetch" href="/assets/js/40.790fe9de.js"><link rel="prefetch" href="/assets/js/41.e11c7f03.js"><link rel="prefetch" href="/assets/js/42.07f7aeb0.js"><link rel="prefetch" href="/assets/js/43.8a499f02.js"><link rel="prefetch" href="/assets/js/44.1bba90da.js"><link rel="prefetch" href="/assets/js/45.796b6892.js"><link rel="prefetch" href="/assets/js/46.4f2b6d71.js"><link rel="prefetch" href="/assets/js/47.98f8414d.js"><link rel="prefetch" href="/assets/js/48.63eb1b00.js"><link rel="prefetch" href="/assets/js/49.d26d6942.js"><link rel="prefetch" href="/assets/js/5.203dfd51.js"><link rel="prefetch" href="/assets/js/50.02bee9d9.js"><link rel="prefetch" href="/assets/js/51.ba1cbd48.js"><link rel="prefetch" href="/assets/js/52.a858baaf.js"><link rel="prefetch" href="/assets/js/53.c13b2fb1.js"><link rel="prefetch" href="/assets/js/54.d0511e8a.js"><link rel="prefetch" href="/assets/js/55.5d8caefd.js"><link rel="prefetch" href="/assets/js/56.b1ff2e94.js"><link rel="prefetch" href="/assets/js/57.b7cf371e.js"><link rel="prefetch" href="/assets/js/58.225ccfdb.js"><link rel="prefetch" href="/assets/js/59.3ceae42b.js"><link rel="prefetch" href="/assets/js/6.2b87caaa.js"><link rel="prefetch" href="/assets/js/60.5bc1d743.js"><link rel="prefetch" href="/assets/js/61.c0f71646.js"><link rel="prefetch" href="/assets/js/62.e48ed134.js"><link rel="prefetch" href="/assets/js/63.734614ba.js"><link rel="prefetch" href="/assets/js/64.eca3948c.js"><link rel="prefetch" href="/assets/js/65.eb73665a.js"><link rel="prefetch" href="/assets/js/66.f90bb25d.js"><link rel="prefetch" href="/assets/js/67.091973a4.js"><link rel="prefetch" href="/assets/js/68.6687b084.js"><link rel="prefetch" href="/assets/js/69.4a638dd2.js"><link rel="prefetch" href="/assets/js/7.838ec26c.js"><link rel="prefetch" href="/assets/js/70.4ce1d646.js"><link rel="prefetch" href="/assets/js/71.f9cd5c98.js"><link rel="prefetch" href="/assets/js/72.0ca8d14f.js"><link rel="prefetch" href="/assets/js/73.8887d15a.js"><link rel="prefetch" href="/assets/js/74.fdf3423c.js"><link rel="prefetch" href="/assets/js/75.9de9ec9f.js"><link rel="prefetch" href="/assets/js/76.ecbf06c0.js"><link rel="prefetch" href="/assets/js/8.d26d194d.js"><link rel="prefetch" href="/assets/js/9.b82b5c16.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.45c7b1bd.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.fc267309.js">
    <link rel="stylesheet" href="/assets/css/0.styles.097f5d83.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-b812d5fc><header class="navbar" data-v-b812d5fc><div class="wrap"><div class="wrap-border"><a href="/" class="home-link router-link-active"><svg role="img" alt="Lightning Dev Kit Documentation" class="logo"><use href="/img/logo.svg#small" class="small"></use> <use href="/img/logo.svg#large" class="large"></use></svg></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/introduction/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/case-studies/" class="nav-link">
  Case Studies
</a></div><div class="nav-item"><a href="/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://discord.gg/5AcknnMfBw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/lightningdevkit/lightningdevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <button type="button" class="theme-switch"><svg viewBox="0 0 30 31" fill="none" xmlns="http://www.w3.org/2000/svg"><g class="theme-switch-dark"><path d="M15 20.4219C12.5187 20.4219 10.5 18.4032 10.5 15.9219C10.5 13.4406 12.5187 11.4219 15 11.4219C17.4813 11.4219 19.5 13.4406 19.5 15.9219C19.5 18.4032 17.4813 20.4219 15 20.4219Z" fill="currentColor"></path> <path d="M19.4541 20.3769L21.3644 22.2862M15 24.9219V22.2219V24.9219ZM15 9.62187V6.92188V9.62187ZM6 15.9219H8.7H6ZM21.3 15.9219H24H21.3ZM8.6361 22.2862L10.5454 20.3769L8.6361 22.2862ZM19.4541 11.4678L21.3644 9.55797L19.4541 11.4678ZM8.6361 9.55797L10.5454 11.4678L8.6361 9.55797Z" stroke="currentColor" stroke-width="1" stroke-linecap="round"></path></g> <g fill="currentColor" class="theme-switch-light"><path d="M10.1539 8.75585C10.018 8.75585 9.88774 8.70189 9.79168 8.60583C9.69563 8.50977 9.64166 8.37949 9.64166 8.24365V6.19482C9.64166 6.05898 9.69563 5.9287 9.79168 5.83264C9.88774 5.73658 10.018 5.68262 10.1539 5.68262C10.2897 5.68262 10.42 5.73658 10.5161 5.83264C10.6121 5.9287 10.6661 6.05898 10.6661 6.19482V8.24365C10.6661 8.37949 10.6121 8.50977 10.5161 8.60583C10.42 8.70189 10.2897 8.75585 10.1539 8.75585Z"></path> <path d="M11.1783 7.73144H9.12945C8.9936 7.73144 8.86332 7.67748 8.76726 7.58142C8.6712 7.48536 8.61724 7.35508 8.61724 7.21924C8.61724 7.08339 8.6712 6.95311 8.76726 6.85705C8.86332 6.761 8.9936 6.70703 9.12945 6.70703H11.1783C11.3141 6.70703 11.4444 6.761 11.5405 6.85705C11.6365 6.95311 11.6905 7.08339 11.6905 7.21924C11.6905 7.35508 11.6365 7.48536 11.5405 7.58142C11.4444 7.67748 11.3141 7.73144 11.1783 7.73144ZM6.05621 13.8779C5.92037 13.8779 5.79009 13.8239 5.69403 13.7279C5.59797 13.6318 5.54401 13.5015 5.54401 13.3657V12.3413C5.54401 12.2054 5.59797 12.0752 5.69403 11.9791C5.79009 11.8831 5.92037 11.8291 6.05621 11.8291C6.19206 11.8291 6.32234 11.8831 6.4184 11.9791C6.51445 12.0752 6.56842 12.2054 6.56842 12.3413V13.3657C6.56842 13.5015 6.51445 13.6318 6.4184 13.7279C6.32234 13.8239 6.19206 13.8779 6.05621 13.8779Z"></path> <path d="M6.56842 13.366H5.544C5.40816 13.366 5.27788 13.312 5.18182 13.216C5.08576 13.1199 5.0318 12.9896 5.0318 12.8538C5.0318 12.7179 5.08576 12.5877 5.18182 12.4916C5.27788 12.3955 5.40816 12.3416 5.544 12.3416H6.56842C6.70426 12.3416 6.83454 12.3955 6.9306 12.4916C7.02666 12.5877 7.08062 12.7179 7.08062 12.8538C7.08062 12.9896 7.02666 13.1199 6.9306 13.216C6.83454 13.312 6.70426 13.366 6.56842 13.366ZM16.8125 23.6101C12.8583 23.6101 9.64165 20.3934 9.64165 16.4392C9.64165 12.8983 12.2851 9.85021 15.7907 9.34876L16.4658 9.25195L16.37 9.92755C16.326 10.218 16.3027 10.5112 16.3003 10.805C16.3003 14.1942 19.0575 16.9514 22.4468 16.9514C22.708 16.9514 22.9872 16.9294 23.3247 16.8813L23.9998 16.7855L23.9035 17.4606C23.401 20.9666 20.3524 23.6101 16.8125 23.6101Z"></path></g></svg></button></div> <div class="sidebar-button"><svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" class="icon"><g fill="currentColor" class="hamburger"><path d="M33.75 11.6699H6.25C5.55964 11.6699 5 12.2296 5 12.9199C5 13.6103 5.55964 14.1699 6.25 14.1699H33.75C34.4404 14.1699 35 13.6103 35 12.9199C35 12.2296 34.4404 11.6699 33.75 11.6699Z"></path> <path d="M28.75 18.752H6.25C5.55964 18.752 5 19.3116 5 20.002C5 20.6923 5.55964 21.252 6.25 21.252H28.75C29.4404 21.252 30 20.6923 30 20.002C30 19.3116 29.4404 18.752 28.75 18.752Z"></path> <path d="M33.75 25.8301H6.25C5.55964 25.8301 5 26.3897 5 27.0801C5 27.7704 5.55964 28.3301 6.25 28.3301H33.75C34.4404 28.3301 35 27.7704 35 27.0801C35 26.3897 34.4404 25.8301 33.75 25.8301Z"></path></g> <g stroke="currentColor" class="close"><path d="M10 10L30 30" stroke-width="2" stroke-linecap="round"></path> <path d="M30 10L10 30" stroke-width="2" stroke-linecap="round"></path></g></svg></div></div></div></header> <div class="wrap" data-v-b812d5fc><div class="wrap-border" data-v-b812d5fc><div class="sidebar-mask" data-v-b812d5fc></div> <aside class="sidebar" data-v-b812d5fc><nav class="nav-links"><div class="nav-item"><a href="/introduction/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/case-studies/" class="nav-link">
  Case Studies
</a></div><div class="nav-item"><a href="/blog/" class="nav-link">
  Blog
</a></div><div class="nav-item"><a href="https://discord.gg/5AcknnMfBw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/lightningdevkit/lightningdevkit.org" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Documentation</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/introduction/" class="sidebar-heading clickable open"><span>Introduction</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/introduction/use-cases/" class="sidebar-link">Use Cases</a></li><li><a href="/introduction/architecture/" class="sidebar-link">Architecture</a></li><li><a href="/introduction/peer-management/" class="sidebar-link">Peer Management</a></li><li><a href="/introduction/persistent_storage/" class="sidebar-link">Persistent Storage</a></li><li><a href="/introduction/blockchain_data/" class="sidebar-link">Blockchain Data</a></li><li><a href="/introduction/wallet_management/" class="sidebar-link">Wallet Management</a></li><li><a href="/introduction/networking/" class="sidebar-link">Networking</a></li><li><a href="/introduction/private_key_management/" class="sidebar-link">Private Key Management</a></li><li><a href="/introduction/transactions/" class="sidebar-link">Transactions</a></li><li><a href="/introduction/random_number_generation/" class="sidebar-link">Random Number Generation</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Building a node with LDK</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/running-a-sample-ldk-node/" class="sidebar-link">Running a sample LDK node</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Blockchain Data</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/key_management/" class="sidebar-link">Key Management</a></li><li><a href="/fee_estimation/" class="sidebar-link">Fee Estimation</a></li><li><a href="/probing/" aria-current="page" class="active sidebar-link">Probing and Path Finding</a></li><li><a href="/examples/" class="sidebar-link">Examples</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>API Reference</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Rust</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="https://docs.rs/lightning/*/lightning/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-background-processor/*/lightning_background_processor/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-background-processor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-block-sync/*/lightning_block_sync/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-block-sync<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-invoice/*/lightning_invoice/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-invoice<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-net-tokio/*/lightning_net_tokio/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-net-tokio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-persister/*/lightning_persister/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-persister<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-rapid-gossip-sync/*/lightning_rapid_gossip_sync/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-rapid-gossip-sync<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-transaction-sync/*/lightning_transaction_sync/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-transaction-sync<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li><a href="https://docs.rs/lightning-custom-message/*/lightning_custom_message/" target="_blank" rel="noopener noreferrer" class="sidebar-link">lightning-custom-message<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></section></li><li><a href="https://github.com/arik-so/SwiftLightning/tree/master/Documentation" target="_blank" rel="noopener noreferrer" class="sidebar-link">Swift<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></section></li></ul> </aside> <!----> <main class="page"> <div class="theme-default-content content__default"><h1 id="probing-and-path-finding"><a href="#probing-and-path-finding" class="header-anchor">#</a> Probing and Path Finding</h1> <h2 id="the-challenge-of-routing-payments-on-the-lightning-network"><a href="#the-challenge-of-routing-payments-on-the-lightning-network" class="header-anchor">#</a> The Challenge of Routing Payments on the Lightning Network</h2> <p>The Lightning Development Kit (LDK) provides you with the software tools to build a node on the Lightning Network. The Lightning Network is a collection of tens of thousands of nodes that, together, enable cheap and private Bitcoin transactions.</p> <p>The challenge is that your node is just one among tens of thousands. While each node has its own internal representation of the Lightning Network graph, the information within this graph is incomplete to optimally route payments. This is largely because, when nodes announce new (or updated) channels to the network, they do not specify how the capacity is distributed between the two channel parties, making it difficult to know for certain if a given channel is a viable option when routing payments. To complicate matters further, liquidity distributions across channels fluctuate as payments move throughout the network. Without regular monitoring, your node’s estimates can quickly become outdated. There’s also the added uncertainty of whether a given channel is online when initiating a payment, increasing the likelihood of payment failure.</p> <p>This presents two fundamental challenges when routing payments on the Lightning Network:</p> <ol><li><strong>Missing Information</strong>: Nodes may not know if a given channel's liquidity is prohibitively unbalanced.</li> <li><strong>Path-Finding Optimization</strong>: If multiple payment paths exist, we must decide which path is the best.</li></ol> <p>To help address both of the above challenges, LDK provides a <a href="https://docs.rs/lightning/latest/lightning/routing/scoring/struct.ProbabilisticScorer.html" target="_blank" rel="noopener noreferrer"><code>ProbabilisticScorer</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> struct. This structure holds information about our node's current view of the Lightning Network graph, including estimates of available liquidity within each channel. It also records historical liquidity observations, which are updated each time our node either fails or succeeds at making a payment (or probe).</p> <p>Ultimately, a <code>ProbabilisticScorer</code> is used to identify the optimal path for routing a payment by scoring each channel in a candidate path. With this information, the <code>ProbabilisticScorer</code> helps identify routes with a high probability of success while minimizing transaction fees.</p> <h3 id="estimating-channel-balance-distribution"><a href="#estimating-channel-balance-distribution" class="header-anchor">#</a> Estimating Channel Balance Distribution</h3> <p>There is a bit of a &quot;cold-start problem&quot; when encountering a new channel, as we have little information on which to base our initial estimates for available liquidity. Therefore, it's important to start gathering data to build up our LDK node's internal estimates of channel balance distributions. To do this, we <strong>&quot;probe&quot;</strong> the network. <strong>Probing</strong> is a process where we send a payment with an <em>invalid</em> payment hash along a route. Since the payment hash is invalid, we know the payment will ultimately fail, so we're not concerned with losing funds. However, we can pay special attention to how the payment fails and learn important information about the Lightning Network graph.</p> <p>For example, imagine our node has, via the gossip protocol, learned about the below path:</p> <figure><img src="/assets/img/abcd_ln_path.e919734f.png" alt="Path"></figure> <p>We know each channel's capacity, but we don't know how that capacity is distributed within the channel (<strong>note</strong>, we do know how our channel capacity is distributed between us and Alice). For example, would a 400,000 sats payment make its way from us to Dianne, or would it fail because almost all 2,000,000 sats are on Bob's side of his channel with Charlie?</p> <p>To answer this question, we decide to send a test payment (probe) of 400,000 sats to Dianne. If we do this, there are two possible outcomes:</p> <ol><li>The payment reaches Dianne, but she doesn't recognize the payment hash (because we sent an invalid one), so she sends an error back to us. If this happens, we've now learned that each channel has an available liquidity of at least 400,000 sats.</li> <li>If the payment fails along the way, we'll get an error informing us <em>where</em> (which channel) the payment failed. If this happens, we've now learned which channel does not have the ability to forward a 400,000 sat payment.</li></ol> <p>If we'd like, we can repeat this process with varying amounts of sats to gain a more precise estimate of each channel's available liquidity for this route. We can then do the same for many other routes, thus building up a robust view of the Lightning Network and, ultimately, empowering us to select the optimal path when routing payments in the future.</p> <p>Probing best practices are discussed in more detail in  <a href="#best-practices"><strong>Best Practices</strong></a>, however, for now, it's sufficient to note that LDK will update its view of the graph each time real and test payments either succeed or fail. Successes and failures are communicated to our LDK node via the <a href="https://docs.rs/lightning/latest/lightning/routing/scoring/trait.ScoreUpdate.html" target="_blank" rel="noopener noreferrer">ScoreUpdate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> trait. These successes and failures serve as historical data points and influence our node's current estimate of available liquidity for each channel.</p> <p>Given that the Lightning Network graph is constantly changing as payments flow throughout the ecosystem, our LDK node must account for the passage of time and assume that channel balances will change even if our node has not probed or otherwise interacted with a channel in a while. To accomplish this, LDK provides <code>ProbabilisticScoringDecayParameters</code>. These parameters configure how each channel’s available liquidity estimates are updated over time. For example, one <code>ProbabilisticScoringDecayParameters</code>configuration is <code>liquidity_offset_half_life</code>. This configuration determines how frequently a channel's upper bound and lower bound available liquidity estimations are updated. For example, after the set time passes (default 6 hours), the channel’s lower bound estimate is cut in half, and the upper bound moves halfway to the channel’s total capacity. For example, if a channel has a 1 million sat capacity, and our node currently estimates its lower bound to be 200,000 sats and an upper bound to be 600,000 sats, then, after <code>liquidity_offset_half_life</code>, it will be updated to 100,000 sats and 800,000 sats. The <code>ProbabilisticScoringDecayParameters</code> can be customized, but default settings are also available. For more details, please see the <code>ProbabilisticScoringDecayParameters</code> <a href="https://docs.rs/lightning/latest/lightning/routing/scoring/struct.ProbabilisticScoringDecayParameters.html" target="_blank" rel="noopener noreferrer">docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="finding-the-optimal-path"><a href="#finding-the-optimal-path" class="header-anchor">#</a> Finding the Optimal Path</h3> <p>The <code>ProbabilisticScorer</code> assists in finding the optimal path by providing our node with a perspective of the Lightning Network graph and the estimated available liquidity for each channel. To assist in finding the optimal payment route, LDK provides <code>ProbabilisticScoringFeeParameters</code>. These fee parameters impact how our node optimizes its routing decisions. Broadly speaking, <code>ProbabilisticScoringFeeParameters</code> contains various parameters that help select paths with desirable properties (ex: fewer hops, reliable, private, low fees, etc.). For example, one setting is <code>liquidity_penalty_amount_multiplier_msat</code>. This configuration defines a multiplier that is used in conjunction with the payment amount flowing over the given channel and our node's estimated probability of successfully routing the total amount (i.e., the payment and any inflight HTLCs) through the channel. This configuration will give a larger penalty to channels that have a low probability of success, and that penalty will grow larger as the payment amount increases.</p> <p>Similar to the <code>ProbabilisticScoringDecayParameters</code>, <code>ProbabilisticScoringFeeParameters</code> parameters are customizable, but defaults are provided. For more information, please visit the <code>ProbabilisticScoringFeeParameters</code> <a href="https://docs.rs/lightning/latest/lightning/routing/scoring/struct.ProbabilisticScoringFeeParameters.html" target="_blank" rel="noopener noreferrer">docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="the-probabilisticscorer"><a href="#the-probabilisticscorer" class="header-anchor">#</a> The <code>ProbabilisticScorer</code></h2> <p>As discussed earlier, the <code>ProbabilisticScorer</code> (seen below) is responsible for maintaining and updating our node's estimates of available channel liquidity.</p> <p>A <code>ProbabilisticScorer</code> has the following fields:</p> <ul><li><code>decay_params</code>: This field holds the decay parameters (<code>ProbabilisticScoringDecayParameters</code>) for the scorer. As mentioned above, these are customizable, but LDK also provides defaults. You can read more about them in the <a href="https://docs.rs/lightning/latest/lightning/routing/scoring/struct.ProbabilisticScoringDecayParameters.html" target="_blank" rel="noopener noreferrer">docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><code>network_graph</code>: This field holds a reference to the network graph.</li> <li><code>logger</code>: This field holds a reference to the logger.</li></ul> <p>Once implemented, the <code>ProbabilisticScorer</code>, along with its parameters (<code>ProbabilisticScoringDecayParameters</code> and <code>ProbabilisticScoringFeeParameters</code>), becomes the backbone of path-finding in LDK. The next section will describe best practices for implementing, training, and serving the <code>ProbabilisticScorer</code> within your application.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ProbabilisticScorer</span><span class="token operator">&lt;</span><span class="token class-name">G</span><span class="token punctuation">:</span> <span class="token class-name">Deref</span><span class="token operator">&lt;</span><span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">NetworkGraph</span><span class="token operator">&lt;</span><span class="token class-name">L</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token class-name">L</span><span class="token punctuation">:</span> <span class="token class-name">Deref</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span> <span class="token class-name">L</span><span class="token punctuation">::</span><span class="token class-name">Target</span><span class="token punctuation">:</span> <span class="token class-name">Logger</span> <span class="token punctuation">{</span>
	decay_params<span class="token punctuation">:</span> <span class="token class-name">ProbabilisticScoringDecayParameters</span><span class="token punctuation">,</span>
	network_graph<span class="token punctuation">:</span> <span class="token class-name">G</span><span class="token punctuation">,</span>
	logger<span class="token punctuation">:</span> <span class="token class-name">L</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="best-practices"><a href="#best-practices" class="header-anchor">#</a> Best Practices</h2> <p>Before digging into best practices for probing, it's important to note that popular Lightning Network implementations such as Core Lightning (CLN), Lightning Network Daemon (LND), and Lightning Development Kit (LDK), have different internal representations of the Lightning Network. Therefore, it's not possible to simply &quot;feed&quot; CLN, LND, or LDK the same scoring file or information when setting up path-finding functionality.</p> <h3 id="general-architecture-approaches"><a href="#general-architecture-approaches" class="header-anchor">#</a> General Architecture Approaches</h3> <p>Now, let's review general architectural approaches for implementing and updating a <code>ProbabilisticScorer</code> in an LDK node. Before getting into the weeds, it's important to note that a <code>ProbabilisticScorer</code> does not perform the probing itself. Instead, it is passed as a parameter when our node finds a route. For a simple analogy, imagine you're seeking advice on how to get from New York City to Washington, DC. There are many paths you can take, but the path you choose will depend on the person you ask. One may suggest taking a train, another a bus, and another a plane.</p> <p>Similarly, the route-finding functionality in LDK is separate from the <code>ProbabilisticScorer</code>, but it takes the scorer as input. If you provide a well-trained scorer, you will likely get a different route than if you provide a fresh scorer.</p> <h4 id="background-process"><a href="#background-process" class="header-anchor">#</a> Background Process</h4> <p>The first approach to updating the <code>ProbabilisticScorer</code> within our application is to program our node to periodically probe in the background. For example, once a minute, our node can attempt to probe a random amount to a random node, updating the scorer with the successes and failures over time. The advantages to this approach are that our node always has access to real-time updates, and we have full control over the probing process. However, running a prober in the background may add additional resource constraints (CPU, memory, bandwidth, etc.) and complexity to our application.</p> <h4 id="create-a-separate-prober-application"><a href="#create-a-separate-prober-application" class="header-anchor">#</a> Create A Separate Prober Application</h4> <p>Another approach for integrating the <code>ProbabilisticScorer</code> is to set up a separate application to perform the probing. In this scenario, the application will periodically probe the network, update the <code>ProbabilisticScorer</code>, and make the serialized scorer available for us to fetch and incorporate into our application. For example, it may serialize and serve the scorer via an HTTP server or make it available on a file system shared by the two applications. The advantages of this approach are that we can simplify our application by moving this functionality to another application, thus reducing the resource usage of our node. However, this approach adds coordination complexity to our application and introduces the risk that our node's <code>ProbabilisticScorer</code> does not have the most current representation of the network.</p> <h3 id="probing"><a href="#probing" class="header-anchor">#</a> Probing</h3> <p>Regardless of which architectural approach you're taking, if you're setting up your own scoring functionality, you'll want to probe the network so that you can build a robust internal representation of the Lightning Network and optimally route payments. To accomplish this, there are a few options you can explore:</p> <ol><li><strong>Random Probing</strong>: As discussed above, one simple approach to update your scorer is to pay a random amount to a random node every minute. While this may sound rudimentary, it's an effective way to build an internal state for how simple it is.</li> <li><strong>Leverage Your Routing History</strong>: If you record a history of payments forwarded by your node, you can leverage that by identifying large or well-ranked nodes that are 1 or 2 hops beyond frequent next-hops from your node. The goal here is to attempt to identify heavily used paths for payments that route through your node. Of course, you do not know the final destination of each payment, which is why you will need to use some heuristics (ex: channel capacity, node rank, etc.) to estimate which paths are heavily used.</li> <li><strong>Probe Large Nodes</strong>: As mentioned above, it can be beneficial to probe large nodes on the network, such as ACINQ. This is because large nodes can often be the final destination for payments, so probing these nodes will help your LDK node understand which paths are viable for varying payment amounts. It's also worth noting that since many channels on the Lightning Network are connected to large nodes, you will likely succeed in probing large nodes via the &quot;Random Probing&quot; approach.</li> <li><strong>Use Multiple <code>ProbabilisticScorer</code></strong>: Your node can leverage multiple <code>ProbabilisticScorer</code> at once. Remember, each scorer has its own internal liquidity estimates and payment history for each channel it knows about. Therefore, it may be beneficial to use a new scorer, which has not been updated, to select a route and then update a different scorer. This approach would help ensure that your node doesn't keep probing the same paths, as your node's updated scorer will likely begin to identify and prefer certain paths once it's sufficiently updated.</li> <li><strong>Vary The Payment Amount</strong>: An intelligent probing setup will vary payment amounts. Two important reasons for doing this are listed below.
<ul><li><strong>Finding New Routes</strong>: Remember, a central part of the path-finding algorithm involves generating penalties for each channel so that your node can select the best path. A key variable when calculating the penalty for each channel is the payment amount. You will likely get different paths for the same source --&gt; destination payment, depending on the amount.</li> <li><strong>Refining Channel Liquidity Estimates</strong>: You can refine your node's estimates of a channel's liquidity by selectively probing that channel with an amount that falls between your node's minimum and maximum liquidity estimates for that channel. To do this, you would leverage <a href="https://docs.rs/lightning/latest/lightning/routing/router/fn.build_route_from_hops.html" target="_blank" rel="noopener noreferrer"><code>lightning::routing::router::build_route_from_hops</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. This function allows you to construct a custom route by providing the public keys of the nodes along the route. The success or failure of this probe payment will help your node narrow its liquidity estimate for the channel so that it's closer to the actual available liquidity.</li></ul></li></ol> <h3 id="a-note-for-mobile-developers"><a href="#a-note-for-mobile-developers" class="header-anchor">#</a> A Note For Mobile Developers</h3> <p>For mobile applications, developers should explore <strong>Rapid Gossip Sync (RGS)</strong>, which provides a quick and efficient way to update your node's view of the Lightning Network graph. By leveraging RGS, your application can quickly retrieve an up-to-date snapshot of the network graph from a semi-trusted server, significantly reducing sync time and data usage. For more information on RGS, you can read LDK's RGS <a href="https://lightningdevkit.org/blog/announcing-rapid-gossip-sync/" target="_blank" rel="noopener noreferrer">article<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="setting-up-a-probabilisticscorer"><a href="#setting-up-a-probabilisticscorer" class="header-anchor">#</a> Setting Up A <code>ProbabilisticScorer</code></h2> <p>Now that we've reviewed the <code>ProbabilisticScorer</code> and provided an overview of what it does within LDK, let's discuss how to implement it so that our node can find the optimal route for a payment.</p> <h4 id="initializing-the-probabilisticscorer"><a href="#initializing-the-probabilisticscorer" class="header-anchor">#</a> Initializing the <code>ProbabilisticScorer</code></h4> <p>We'll start by initializing the <code>ProbabilisticScorer</code>. For this example, we'll assume that various components, such as a <code>Logger</code> and <code>ChannelManager</code>, have already been created. If you would like to view the documentation on how to initialize these, please see the <a href="https://lightningdevkit.org/building-a-node-with-ldk/setting-up-a-channel-manager/" target="_blank" rel="noopener noreferrer">docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Initialize the Logger.</span>
<span class="token keyword">let</span> logger <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">FilesystemLogger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>ldk_data_dir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize the Network Graph.</span>
<span class="token keyword">let</span> network_graph_path <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{}/network_graph&quot;</span><span class="token punctuation">,</span> ldk_data_dir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> network_graph <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">disk<span class="token punctuation">::</span></span><span class="token function">read_network</span><span class="token punctuation">(</span><span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>network_graph_path<span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span>network<span class="token punctuation">,</span> logger<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize the Scorer.</span>
<span class="token keyword">let</span> scorer_path <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{}/scorer&quot;</span><span class="token punctuation">,</span> ldk_data_dir<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> scorer <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RwLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">disk<span class="token punctuation">::</span></span><span class="token function">read_scorer</span><span class="token punctuation">(</span>
    <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scorer_path<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>network_graph<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>logger<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>To create the <code>scorer</code>, the above code utilizes a <code>read_scorer</code> function, which resides in our application's <code>disk.rs</code> file. The function has been provided below. In it, you can see that we are first attempting to read the scorer from our application's data folder. If a scorer is available, we will use that. If not, we'll create a new scorer. It's worth noting that, if we decided to retrieve a scorer via an alternative method such as an HTTP server, we could adjust this function to include that logic.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">read_scorer</span><span class="token punctuation">(</span>
	path<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Path</span><span class="token punctuation">,</span> graph<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">NetworkGraph</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> logger<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">FilesystemLogger</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProbabilisticScorer</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">NetworkGraph</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">FilesystemLogger</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token class-name">ProbabilisticScoringDecayParameters</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>graph<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>scorer<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">ProbabilisticScorer</span><span class="token punctuation">::</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> scorer<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">ProbabilisticScorer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="setting-up-our-probing-logic"><a href="#setting-up-our-probing-logic" class="header-anchor">#</a> Setting Up Our Probing Logic</h4> <p>For this example, we'll build a simple prober that fetches a random node from our <code>NetworkGraph</code> and attempts to send that node a random payment. We'll start by creating a function that fetches a random node from our <code>NetworkGraph</code>. If we cannot find a node, the function will return, and we will not probe any nodes. If we're able to identify a node to probe, then we'll select a random payment amount of up to 500,000,000 milli-satoshis. As a reminder, 1 satoshi = 1,000 milli-satoshis. Finally, we'll get the public key for the node we selected and call <code>send_probe</code>, which is defined later in this documentation.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">send_rand_probe</span><span class="token punctuation">(</span>
    channel_manager<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">ChannelManager</span><span class="token punctuation">,</span> graph<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">NetworkGraph</span><span class="token punctuation">,</span>
    logger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">disk<span class="token punctuation">::</span></span><span class="token class-name">FilesystemLogger</span><span class="token punctuation">,</span>
    scorer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">RwLock</span><span class="token operator">&lt;</span><span class="token class-name">ProbabilisticScorer</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">NetworkGraph</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token namespace">disk<span class="token punctuation">::</span></span><span class="token class-name">FilesystemLogger</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> recipient <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token comment">// Get read-only lock on graph.</span>
        <span class="token keyword">let</span> read_only_graph <span class="token operator">=</span> graph<span class="token punctuation">.</span><span class="token function">read_only</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Check if graph has any nodes we can probe. If none, return.</span>
        <span class="token keyword">if</span> read_only_graph<span class="token punctuation">.</span><span class="token function">nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token comment">// Select random node from the graph.</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> it <span class="token operator">=</span> read_only_graph<span class="token punctuation">.</span><span class="token function">nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unordered_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span><span class="token punctuation">::</span><span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">random</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">usize</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> read_only_graph<span class="token punctuation">.</span><span class="token function">nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Generate a random amount for the probe - up to 500,000,000 milli-satoshis.</span>
    <span class="token keyword">let</span> amt <span class="token operator">=</span> <span class="token punctuation">::</span><span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">random</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">500_000_000</span><span class="token punctuation">;</span>

    <span class="token comment">// If we can convert the node ID to a public key, send probe.</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>pk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">bitcoin<span class="token punctuation">::</span>secp256k1<span class="token punctuation">::</span></span><span class="token class-name">PublicKey</span><span class="token punctuation">::</span><span class="token function">from_slice</span><span class="token punctuation">(</span>recipient<span class="token punctuation">.</span><span class="token function">as_slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">send_probe</span><span class="token punctuation">(</span>channel_manager<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> graph<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> amt<span class="token punctuation">,</span> scorer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Else, return nothing and do not probe.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="sending-probes"><a href="#sending-probes" class="header-anchor">#</a> Sending Probes</h4> <p>Now that we've identified the recipient and amount for our probe, let's write a function to find the route for our payment. The <code>ProbabilisticScorer</code> that is used to score various routes will be passed as an input to this function. Recall that earlier, we discussed the concept of using multiple scorers. One scorer that we actually save results to and another un-updated scorer that can be used to identify routes with a &quot;beginner's mind&quot; - so to speak. If we'd like to leverage this approach, we can pass an un-updated scorer here and then update a different scorer with the results of the probe.</p> <p>Also, note that this function is referencing a <code>ScorerAccountingForInFlightHtlcs</code>. This structure wraps around an existing scorer and incorporates information regarding in-flight (not yet settled) HTLC's, allowing our scorer to incorporate real-time payment flows as part of its routing optimization. We also define the scoring parameters, <code>ProbabilisticScoringFeeParameters</code>, in this function. As discussed earlier, LDK provides default parameters, but you can customize these if you like.</p> <p>Finally, if we're able to find a route for our payment, we iterate over each path and send a probe.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">send_probe</span><span class="token punctuation">(</span>
    channel_manager<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">ChannelManager</span><span class="token punctuation">,</span> recipient<span class="token punctuation">:</span> <span class="token class-name">PublicKey</span><span class="token punctuation">,</span> graph<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">NetworkGraph</span><span class="token punctuation">,</span>
    logger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">disk<span class="token punctuation">::</span></span><span class="token class-name">FilesystemLogger</span><span class="token punctuation">,</span> amt_msat<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    scorer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">RwLock</span><span class="token operator">&lt;</span><span class="token class-name">ProbabilisticScorer</span><span class="token operator">&lt;</span><span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">NetworkGraph</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token namespace">disk<span class="token punctuation">::</span></span><span class="token class-name">FilesystemLogger</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Get usable channels from the channel manager.</span>
    <span class="token keyword">let</span> chans <span class="token operator">=</span> channel_manager<span class="token punctuation">.</span><span class="token function">list_usable_channels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> chan_refs <span class="token operator">=</span> chans<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>a<span class="token closure-punctuation punctuation">|</span></span> a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get payment parameters for the probe (payee features, route hints, max CLTV expiry delta, max hops, etc.)</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> payment_params <span class="token operator">=</span> <span class="token class-name">PaymentParameters</span><span class="token punctuation">::</span><span class="token function">from_node_id</span><span class="token punctuation">(</span>recipient<span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payment_params<span class="token punctuation">.</span>max_path_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Limit to a single path for the probe</span>

    <span class="token comment">// Get in-flight HTLCs so we can account for in-use channel liquidity.</span>
    <span class="token keyword">let</span> in_flight_htlcs <span class="token operator">=</span> channel_manager<span class="token punctuation">.</span><span class="token function">compute_inflight_htlcs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Acquire a read lock on the scorer.</span>
    <span class="token keyword">let</span> scorer <span class="token operator">=</span> scorer<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a scorer that accounts for in-flight HTLCs.</span>
    <span class="token keyword">let</span> inflight_scorer <span class="token operator">=</span> <span class="token class-name">ScorerAccountingForInFlightHtlcs</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>scorer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>in_flight_htlcs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Use default scoring fee parameters.</span>
    <span class="token keyword">let</span> score_params<span class="token punctuation">:</span> <span class="token class-name">ProbabilisticScoringFeeParameters</span> <span class="token operator">=</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Attempt to find a route for the probe (routes can contain multiple paths)</span>
    <span class="token keyword">let</span> route_res <span class="token operator">=</span> <span class="token namespace">lightning<span class="token punctuation">::</span>routing<span class="token punctuation">::</span>router<span class="token punctuation">::</span></span><span class="token function">find_route</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>channel_manager<span class="token punctuation">.</span><span class="token function">get_our_node_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token class-name">RouteParameters</span><span class="token punctuation">::</span><span class="token function">from_payment_params_and_value</span><span class="token punctuation">(</span>payment_params<span class="token punctuation">,</span> amt_msat<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>graph<span class="token punctuation">,</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chan_refs<span class="token punctuation">)</span><span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inflight_scorer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>score_params<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">match</span> route_res <span class="token punctuation">{</span>
	<span class="token class-name">Ok</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// Iterate over each path.</span>
		<span class="token keyword">for</span> path <span class="token keyword">in</span> route<span class="token punctuation">.</span>paths <span class="token punctuation">{</span>
			<span class="token keyword">let</span> _ <span class="token operator">=</span> channel_manager<span class="token punctuation">.</span><span class="token function">send_probe</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to find a route: {:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="updating-our-scorer"><a href="#updating-our-scorer" class="header-anchor">#</a> Updating Our Scorer</h4> <p>LDK leverages an event-driven architecture, allowing for asynchronous result notification. Therefore, to update our scorer over time, we'll want to inform our application that it should be on the lookout for payment or probing-related events, as these are what indicate to our node that a given route has succeeded or failed. The specific events that we should be watching for and handling are <code>Event::PaymentPathFailed</code>, <code>Event::PaymentPathSuccessful</code>, <code>Event::ProbeSuccessful</code>, and <code>Event::ProbeFailed</code>. There are many other event types. For extensive documentation of LDK events, please see the <a href="https://docs.rs/lightning/latest/lightning/events/enum.Event.html" target="_blank" rel="noopener noreferrer">documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>To handle the above events and other tasks that either can or should run in the background, LDK provides the <a href="https://docs.rs/lightning-background-processor/latest/lightning_background_processor/fn.process_events_async.html" target="_blank" rel="noopener noreferrer"><code>process_events_async</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function within the <code>lightning-background-processor</code> crate. When instantiated, this starts an asynchronous process of handling lightning network node operations, such as maintaining our node's view of the network graph, updating the scorer, and more.</p> <p>To instantiate the background processor, you need to pass in the required components, handlers, and configuration parameters. It's worth noting that one of the handlers that is passed into this function is our own application's event handler. When the background processor picks up a new event, it will first intercept the event and, if applicable, handle it itself (ex: update and persist the scorer) before passing it on to the user's event handler.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Create a watch channel for signaling background processor exit.</span>
<span class="token comment">//</span>
<span class="token comment">// bp_exit: Sender to signal the background processor to exit.</span>
<span class="token comment">// bp_exit_check: Receiver to check for exit signals in the background processor.</span>
<span class="token comment">//</span>
<span class="token comment">// This channel allows for a graceful shutdown of the background processor</span>
<span class="token comment">// by sending a signal that can be checked at appropriate intervals.</span>
<span class="token keyword">let</span> <span class="token punctuation">(</span>bp_exit<span class="token punctuation">,</span> bp_exit_check<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">tokio<span class="token punctuation">::</span>sync<span class="token punctuation">::</span>watch<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> background_processor <span class="token operator">=</span> <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token function">process_events_async</span><span class="token punctuation">(</span>
    <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>persister<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// Persister for writing/reading from file system.</span>
    event_handler<span class="token punctuation">,</span>           <span class="token comment">// Handler for processing various LDK events.</span>
    chain_monitor<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment">// Monitors blocks for relevant activity.</span>
    channel_manager<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Responsible for managing tasks related to channel state.</span>
    <span class="token class-name">GossipSync</span><span class="token punctuation">::</span><span class="token function">p2p</span><span class="token punctuation">(</span>gossip_sync<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Handles P2P network gossip.</span>
    peer_manager<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// Manages peer connections and associated data.</span>
    logger<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">// Logger for recording events and errors.</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span>scorer<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// Scorer for updating and persisting scoring updates.</span>
    <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>t<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// Custom sleep function that can be interrupted.</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> bp_exit_fut_check <span class="token operator">=</span> bp_exit_check<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token macro property">select!</span> <span class="token punctuation">{</span>
                _ <span class="token operator">=</span> <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// Sleep completed.</span>
                _ <span class="token operator">=</span> bp_exit_fut_check<span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// Exit signal received</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// Flag to indicate whether to interrupt on shutdown.</span>
    <span class="token operator">||</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">duration_since</span><span class="token punctuation">(</span><span class="token class-name">SystemTime</span><span class="token punctuation">::</span><span class="token constant">UNIX_EPOCH</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// Current time provider.</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Once the background processor is started, it will call <code>update_scorer</code> as it handles relevant events. For informational purposes, the code that is executed within the background processor to update the scorer is provided below, but you do not need to implement this yourself.</p> <p>As you can see, when payments or probes fail, we update our scorer, further refining its internal estimations of available liquidity on the Lightning Network so that we're better able to route &quot;real&quot; payments when the time comes.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// Updates scorer based on event and returns whether an update occurred so we can decide whether</span>
<span class="token comment">/// to persist.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">update_scorer</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'static</span> <span class="token operator">+</span> <span class="token class-name">Deref</span><span class="token operator">&lt;</span><span class="token class-name">Target</span> <span class="token operator">=</span> <span class="token constant">SC</span><span class="token operator">&gt;</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span><span class="token punctuation">,</span> <span class="token constant">SC</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'a</span> <span class="token operator">+</span> <span class="token class-name">WriteableScore</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>
	scorer<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">S</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Event</span><span class="token punctuation">,</span> duration_since_epoch<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">match</span> event <span class="token punctuation">{</span>
		<span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">PaymentPathFailed</span> <span class="token punctuation">{</span> <span class="token keyword">ref</span> path<span class="token punctuation">,</span> short_channel_id<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>scid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> <span class="token keyword">mut</span> score <span class="token operator">=</span> scorer<span class="token punctuation">.</span><span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			score<span class="token punctuation">.</span><span class="token function">payment_path_failed</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">*</span>scid<span class="token punctuation">,</span> duration_since_epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">PaymentPathFailed</span> <span class="token punctuation">{</span> <span class="token keyword">ref</span> path<span class="token punctuation">,</span> payment_failed_permanently<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token comment">// Reached if the destination explicitly failed it back. We treat this as a successful probe</span>
			<span class="token comment">// because the payment made it all the way to the destination with sufficient liquidity.</span>
			<span class="token keyword">let</span> <span class="token keyword">mut</span> score <span class="token operator">=</span> scorer<span class="token punctuation">.</span><span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			score<span class="token punctuation">.</span><span class="token function">probe_successful</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> duration_since_epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">PaymentPathSuccessful</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> <span class="token keyword">mut</span> score <span class="token operator">=</span> scorer<span class="token punctuation">.</span><span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			score<span class="token punctuation">.</span><span class="token function">payment_path_successful</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> duration_since_epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">ProbeSuccessful</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> <span class="token keyword">mut</span> score <span class="token operator">=</span> scorer<span class="token punctuation">.</span><span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			score<span class="token punctuation">.</span><span class="token function">probe_successful</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> duration_since_epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token class-name">Event</span><span class="token punctuation">::</span>ailed <span class="token punctuation">{</span> path<span class="token punctuation">,</span> short_channel_id<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>scid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> <span class="token keyword">mut</span> score <span class="token operator">=</span> scorer<span class="token punctuation">.</span><span class="token function">write_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			score<span class="token punctuation">.</span><span class="token function">probe_failed</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">*</span>scid<span class="token punctuation">,</span> duration_since_epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		_ <span class="token operator">=&gt;</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It's important that our scorer also observes the passage of time. This is because if our scorer has not received any recent updates for a channel, it will need to broaden its current estimates for available channel liquidity. You can read more about the <code>time_passed</code> parameter in the <a href="https://docs.rs/lightning/latest/lightning/routing/scoring/trait.ScoreUpdate.html#tymethod.time_passed" target="_blank" rel="noopener noreferrer">docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Similar to handling payment and probe-related events, the background processor that we created in the previous section will call <code>time_passed</code> on our scorer and persist the updated scorer every 5 minutes.</p> <h4 id="sending-probes-2"><a href="#sending-probes-2" class="header-anchor">#</a> Sending Probes</h4> <p>We're almost done! Now that we have probing functionality built out and the ability to update our scorer with the results, we just need to tell our application to send a probe randomly, once per minute.</p> <p>Within your application, you will likely have a main entry point where you initialize important LDK components such as the <code>ChannelManager</code>, <code>ChainMonitor</code>, and the <code>ProbabilisticScorer</code> itself. Since all of the required components will be available within this asynchronous entry point, we can configure our app to send a probe every 60 seconds by calling the functions we previously created and passing in the required components.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Regularly probe.</span>
<span class="token keyword">let</span> probing_cm <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>channel_manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> probing_graph <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>network_graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> probing_logger <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create a fresh scorer for probing.</span>
<span class="token keyword">let</span> probing_scorer <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RwLock</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">ProbabilisticScorer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
	<span class="token class-name">ProbabilisticScoringDecayParameters</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	probing_graph<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	probing_logger<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token namespace">tokio<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> <span class="token keyword">mut</span> probe_interval <span class="token operator">=</span> <span class="token namespace">tokio<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">loop</span> <span class="token punctuation">{</span>
		probe_interval<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
		<span class="token function">send_rand_probe</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">*</span>probing_cm<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token operator">*</span>probing_graph<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token operator">*</span>probing_logger<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token operator">*</span>probing_scorer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lightningdevkit/lightningdevkit.org/edit/main/docs/probing.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/18/2025, 3:16:29 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fee_estimation/" class="prev">
        Fee Estimation
      </a></span> <span class="next"><a href="/examples/">
        Examples
      </a>
      →
    </span></p></div> </main></div></div> <footer class="footer" data-v-b812d5fc><div class="wrap"><div class="wrap-border"><div class="inner"><div class="footer-content"><div class="footer-block"><h4>Docs</h4> <div><a href="/introduction/" class="nav-link">
  Introduction
</a></div><div><a href="/building-a-node-with-ldk/introduction.html" class="nav-link">
  Building a node with LDK
</a></div><div><a href="/running-a-sample-ldk-node/" class="nav-link">
  Running a sample LDK node
</a></div><div><a href="/introduction/architecture/" class="nav-link">
  Architecture
</a></div><div><a href="/blockchain_data/introduction/" class="nav-link">
  Blockchain Data
</a></div><div><a href="/key_management/" class="nav-link">
  Key Management
</a></div><div><a href="/fee_estimation/" class="nav-link">
  Fee Estimation
</a></div><div><a href="/probing/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Probing and Path Finding
</a></div><div><a href="/examples/" class="nav-link">
  Examples
</a></div></div><div class="footer-block"><h4>Community</h4> <div><a href="https://github.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://twitter.com/lightningdevkit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Twitter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://discord.gg/5AcknnMfBw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat on Discord
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://calendar.google.com/calendar/embed?src=c_e6fv6vlshbpoob2mmbvblkkoj4%40group.calendar.google.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LDK Calendar
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="http://ldk.reviews/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LDK Review Club
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="/code-of-conduct/" class="nav-link">
  Code of Conduct
</a></div></div><div class="footer-block"><h4>Resources</h4> <div><a href="/case-studies/" class="nav-link">
  Case Studies
</a></div><div><a href="/blog/" class="nav-link">
  Blog
</a></div></div><div class="footer-block"><h4>Other</h4> <div><a href="https://bitcoindevkit.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bitcoin Dev Kit
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div><a href="https://github.com/lightningdevkit/rust-lightning/blob/main/SECURITY.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Reporting a Vulnerability
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div></div> <p class="copyright">Copyright © 2024 LDK Developers</p></div></div></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7d2abb65.js" defer></script><script src="/assets/js/10.e6e8a98f.js" defer></script><script src="/assets/js/1.849294d7.js" defer></script><script src="/assets/js/32.148c6653.js" defer></script>
  </body>
</html>
