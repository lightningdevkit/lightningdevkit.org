(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{73:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return c})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return s})),n.d(t,"default",(function(){return b}));var a=n(3),i=n(7),r=(n(0),n(87)),c={id:"build_node",title:"Building a Node: Checklist"},l={unversionedId:"build_node",id:"build_node",isDocsHomePage:!1,title:"Building a Node: Checklist",description:"Introduction",source:"@site/docs/build_node.md",slug:"/build_node",permalink:"/docs/build_node",editUrl:"https://github.com/lightningdevkit/lightningdevkit.org/tree/main/docs/build_node.md",version:"current",sidebar:"someSidebar",previous:{title:"References",permalink:"/docs/references"},next:{title:"Opening a Channel with LDK",permalink:"/docs/open_channel"}},s=[{value:"Introduction",id:"introduction",children:[]},{value:"Startup Checklist",id:"startup-checklist",children:[]},{value:"Running LDK Checklist",id:"running-ldk-checklist",children:[]},{value:"Using LDK",id:"using-ldk",children:[]}],o={toc:s};function b(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},o,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"introduction"},"Introduction"),Object(r.b)("p",null,"This document is a few checklists for everything you need to make a node using LDK."),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"The first checklist is everything you need to do on startup."),Object(r.b)("li",{parentName:"ul"},"The second checklist is everything you need to do while LDK is running to keep it operational."),Object(r.b)("li",{parentName:"ul"},"The third checklist covers most lightning operations you'll want to use, such as opening a channel")),Object(r.b)("p",null,"Note that LDK does not assume that safe shutdown is available, so there is no\nshutdown checklist."),Object(r.b)("p",null,"This guide covers all major LDK operations besides sending and receiving payments,\nwhich are supported but not yet part of this guide."),Object(r.b)("h2",{id:"startup-checklist"},"Startup Checklist"),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the fee estimator",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: estimating fees for on-chain transactions that LDK wants broadcasted."),Object(r.b)("li",{parentName:"ul"},"Dependencies: none"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/chain/chaininterface/trait.FeeEstimator.html"}),"Rust docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/FeeEstimator.java"}),"Java bindings"))))),Object(r.b)("p",null,"Example fee estimator that always returns ",Object(r.b)("inlineCode",{parentName:"p"},"253")," satoshis:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// FeeEstimatorInterface is a functional interface, so we can implement it with a lambda\nfinal fee_estimator = FeeEstimator.new_impl((confirmation_target -> 253));\n")),Object(r.b)("p",null,"Rather than using static fees, you'll want to fill in the lambda with fetching up-to-date fees from a source like bitcoin core or your own API endpoint."),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the logger")),Object(r.b)("p",null,"Example logger that prints to the console:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// LoggerInterface is a functional interface, so we can implement it with a lambda\nfinal logger = Logger.new_impl((String arg) -> System.out.println(arg));\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the transaction broadcaster",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: broadcasting various lightning transactions "),Object(r.b)("li",{parentName:"ul"},"Dependencies: none"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/chain/chaininterface/trait.BroadcasterInterface.html"}),"Rust docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/BroadcasterInterface.java"}),"Java bindings"))))),Object(r.b)("p",null,"Example transaction broadcaster skeleton:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// Note that the `tx` argument is a []byte type. \nfinal tx_broadcaster = BroadcasterInterface.new_impl(tx -> {\n    <insert code to actually broadcast the given transaction here>\n});\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the channel data persister",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: persisting crucial channel data in a timely manner"),Object(r.b)("li",{parentName:"ul"},"Dependencies: none"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/chain/channelmonitor/trait.Persist.html"}),"Rust docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/Persist.java"}),"Java bindings")),Object(r.b)("li",{parentName:"ul"},"Example:")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"Persist persister = Persist.new_impl(new Persist.PersistInterface() {\n  @Override\n  public Result_NoneChannelMonitorUpdateErrZ persist_new_channel(OutPoint id, ChannelMonitor data) {\n      byte[] channel_monitor_bytes = data.write();\n      <insert code to write these bytes to disk, keyed by `OutPoint`>\n  }\n\n  @Override\n  public Result_NoneChannelMonitorUpdateErrZ update_persisted_channel(OutPoint id, ChannelMonitorUpdate update, ChannelMonitor data) {\n      byte[] channel_monitor_bytes = data.write();\n      <insert code to update the channel monitor's file on disk with these new bytes, keyed by `OutPoint`>\n  }\n});\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the chain monitor",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: monitoring the chain for lighting transactions that are relevant to our node, and broadcasting force close transactions if need be"),Object(r.b)("li",{parentName:"ul"},"Dependencies: fee estimator, logger, transaction broadcaster, channel data persister"),Object(r.b)("li",{parentName:"ul"},"Optional dependency: a chain filter that allows LDK to let you know what transactions you should filter blocks for. This is useful if you pre-filter blocks or use compact filters. Otherwise, LDK will need full blocks."),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/chain/chainmonitor/struct.ChainMonitor.html"}),"Rust docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/ChainMonitor.java"}),"Java bindings"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/chain/trait.Filter.html"}),"Rust ",Object(r.b)("inlineCode",{parentName:"a"},"Filter")," docs")),Object(r.b)("li",{parentName:"ul"},"Example:")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// Example of a ChainMonitor if you *are* running a light client or filtering for transactions:\nFilter tx_filter = Filter.new_impl(new Filter.FilterInterface() {\n    @Override\n    public void register_tx(byte[] txid, byte[] script_pubkey) {\n        <insert code for you to watch for this transaction on-chain>\n    }\n    \n    @Override\n    void register_output(OutPoint outpoint, byte[] script_pubkey) {\n        <insert code for you to watch for any transactions that spend this output on-chain>\n    }\n});\nfinal chain_monitor = ChainMonitor.constructor_new(tx_filter, tx_broadcaster, logger, fee_estimator, persister);\n\n// Example of a ChainMonitor if you are *not* running a light client and can provide\nfull blocks:\nfinal chain_monitor = ChainMonitor.constructor_new(null, tx_broadcaster, logger, fee_estimator, persister);\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the keys manager",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: providing keys for signing lightning transactions"),Object(r.b)("li",{parentName:"ul"},"Dependencies: random bytes, the current bitcoin network"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/chain/keysinterface/struct.KeysManager.html"}),"Rust docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/KeysManager.java"}),"Java bindings")),Object(r.b)("li",{parentName:"ul"},"Example:")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"byte[] key_seed = new byte[32];\n<insert code to fill key_seed with random bytes>\n// Notes about this KeysManager:\n// * it is parameterized by the mainnet bitcoin network, but this should be \n//   swapped out for testnet or regtest as needed.\n// * the current time is part of the parameters because it is used to derive random\n//   numbers from the seed where required, to ensure all random generation is\n//   unique across restarts.\nKeysManager keys = KeysManager.constructor_new(key_seed, LDKNetwork.LDKNetwork_Bitcoin, System.currentTimeMillis() / 1000, (int) (System.currentTimeMillis() * 1000));\n")),Object(r.b)("p",null,"See the Key Management guide for more information."),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the channel manager",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: managing channel state"),Object(r.b)("li",{parentName:"ul"},"Dependencies: keys manager, fee estimator, chain monitor, transaction broadcaster, logger, channel configuration info, and the set of channel monitors we read from disk in the previous step"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/ln/channelmanager/struct.ChannelManager.html"}),"Rust ",Object(r.b)("inlineCode",{parentName:"a"},"ChannelManager")," docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/ChannelManager.java"}),"Java ",Object(r.b)("inlineCode",{parentName:"a"},"ChannelManager")," bindings"))))),Object(r.b)("p",null,"Example of initializing a channel manager on a fresh node:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"final chain_watch = chain_monitor.as_Watch();\nint block_height = <insert current chain tip height>;\nfinal channel_manager = ChannelManager.constructor_new(\n    LDKNetwork.LDKNetwork_Bitcoin, fee_estimator, chain_monitor.as_Watch(), \n    tx_broadcaster, logger, keys_manager.as_KeysInterface(), \n    UserConfig.constructor_default(), block_height);\n")),Object(r.b)("p",null,"Example of initializing a channel manager on restart:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'byte[] serialized_channel_manager = <insert bytes you would have written in following the later step "Persist channel manager">;\nResult_C2Tuple_BlockHashChannelManagerZDecodeErrorZ channel_manager_read_result =\n  UtilMethods.constructor_BlockHashChannelManagerZ_read(serialized_channel_manager, \n  keys_interface, fee_estimator, chain_monitor.as_Watch(), tx_broadcaster, logger,\n  UserConfig.constructor_default(), channel_monitors);\n\n// Assert we were able to read successfully.\nassert channel_manager_read_result instanceof Result_C2Tuple_BlockHashChannelManagerZDecodeErrorZ.Result_C2Tuple_BlockHashChannelManagerZDecodeErrorZ_OK;\n\nfinal channel_manager = ((Result_C2Tuple_BlockHashChannelManagerZDecodeErrorZ\n    .Result_C2Tuple_BlockHashChannelManagerZDecodeErrorZ_OK) channel_manager_read_result)\n    .res.b;\n')),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","If LDK is restarting, fill in the chain monitor's existing channel monitor state",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Dependencies: keys manager, chain monitor, and channel manager should be initialized before this step"),Object(r.b)("li",{parentName:"ul"},"If LDK is restarting and has existing channels, then it's very important to read its current channel state off of disk during the restart process."),Object(r.b)("li",{parentName:"ul"},"Equally important: when you read each channel monitor off of disk, it comes with a blockhash which was the last block the channel monitor saw. So it's very important to take this blockhash, and:",Object(r.b)("ol",{parentName:"li"},Object(r.b)("li",{parentName:"ol"},"If the blockhash is on a fork that's no longer current to the chain, then first you need to disconnect blocks until the channel monitor gets to the common ancestor with the main chain"),Object(r.b)("li",{parentName:"ol"},"Then after this disconnection happens if it needs to, you then need to connect recent blocks until the channel monitor is at the current chain tip.")))))),Object(r.b)("p",null,"Example of reading channel monitors from disk, where each channel monitor's file is named after its funding outpoint:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'byte[] channel_monitor_bytes = <read the bytes from disk the same way you wrote them in step "Initialize the channel data persister">;\nResult_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ channel_monitor_read_result = \n    UtilMethods.constructor_BlockHashChannelMonitorZ_read(monitor_bytes, keys_interface);\n\n// Assert that the result of reading bytes from disk is OK.\nassert channel_monitor_read_result instanceof Result_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ.Result_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ_OK;\n\n// Cast the result of reading bytes from disk into its type in the `success` read case.\nTwoTuple<OutPoint, byte[]> funding_txo_and_monitor = \n    ((Result_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ\n    .Result_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ_OK) channel_monitor_read_result)\n\n// Take the ChannelMonitor out of the result, ignoring the latest block hash.\nChannelMonitor monitor = ((Result_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ\n    .Result_C2Tuple_BlockHashChannelMonitorZDecodeErrorZ_OK) res).res.b;\n\n<insert code here to bring the channel monitor up to chain tip>\n\n// Give the channel monitor to the chain monitor.\nfinal chain_watch = chain_monitor.as_Watch();\nchain_watch.watch_channel(mon.get_funding_txo().a, mon);\n')),Object(r.b)("p",null,"Rust example of bringing a channel monitor up to chain tip: ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/rust-bitcoin/rust-lightning/pull/763/files#diff-f457bab978fc8b89ad308d5195f99d7b65a4a6ba1673c5f164104b2dda9a0db6R251"}),"https://github.com/rust-bitcoin/rust-lightning/pull/763/files#diff-f457bab978fc8b89ad308d5195f99d7b65a4a6ba1673c5f164104b2dda9a0db6R251")," where the channel monitor is the ",Object(r.b)("inlineCode",{parentName:"p"},"chain_listener")," parameter. See the linked function and the ",Object(r.b)("inlineCode",{parentName:"p"},"find_fork")," function within it."),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Optional: initialize the router (which we call the ",Object(r.b)("inlineCode",{parentName:"li"},"NetGraphMsgHandler"),")",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: generating routes to send payments over"),Object(r.b)("li",{parentName:"ul"},"Dependencies: logger"),Object(r.b)("li",{parentName:"ul"},"Optional dependency: source of chain information, recommended for light clients to be able to verify channels"),Object(r.b)("li",{parentName:"ul"},"Example:")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"final router = NetGraphMsgHandler.constructor_new(new byte[32], null, logger);\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Initialize the peer manager using LDK's ",Object(r.b)("inlineCode",{parentName:"li"},"PeerManager")," struct combined with LDK's supplied ",Object(r.b)("inlineCode",{parentName:"li"},"NioPeerHandler")," networking battery",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: connecting to peers, facilitating peer data to and from LDK"),Object(r.b)("li",{parentName:"ul"},"Dependencies: channel manager, router (optional), keys manager, random bytes, logger"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://docs.rs/lightning/0.0.12/lightning/ln/peer_handler/struct.PeerManager.html"}),"Rust docs"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/PeerManager.java"}),"Java ",Object(r.b)("inlineCode",{parentName:"a"},"PeerManager")," bindings"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/batteries/NioPeerHandler.java"}),"Java ",Object(r.b)("inlineCode",{parentName:"a"},"NioPeerHandler")))))),Object(r.b)("p",null,"Example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'byte[] random_data = new byte[32];\n<insert code to fill in `random_data` with random bytes>\nfinal nio_peer_handler;\nfinal peer_manager = PeerManager.constructor_new(chan_manager.as_ChannelMessageHandler(),\n    router.as_RoutingMessageHandler(), keys_interface.get_node_secret(), random_data, logger);\ntry { nio_peer_handler = new NioPeerHandler(peer_manager); } catch (IOException e) { assert false; }\n\n// Finally, start NioPeerHandler listening for connections.\nfinal port = 9735;\nnio_peer_handler.bind_listener(new InetSocketAddress("127.0.0.1", port));\n')),Object(r.b)("h2",{id:"running-ldk-checklist"},"Running LDK Checklist"),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Connect and disconnect blocks to LDK as they come in. Note that blocks must be connected and disconnected in chain order.")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// header is a []byte type, height is `int`, txdata is a \n// TwoTuple<Long, byte[]>[], where the 0th element is the transaction's position \n// in the block (with the coinbase transaction considered position 0) and the 1st \n// element is the transaction bytes\nchannel_manager.block_connected(header, txn, height);\nchain_monitor.block_connected(header, txn, height);\n\nchannel_manager.block_disconnected(header);\nchain_monitor.block_disconnected(header);\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Handle the channel manager's generate events as they come in",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: the channel manager and chain monitor generate events that must be handled by you, such as telling you when a payment has been successfully received or when a funding transaction is ready for broadcast."),Object(r.b)("li",{parentName:"ul"},"Dependencies: channel manager and chain monitor"),Object(r.b)("li",{parentName:"ul"},"References: ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/lightningdevkit/ldk-garbagecollected/blob/main/src/main/java/org/ldk/structs/Event.java"}),"events to handle in Java"),", ",Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/TheBlueMatt/rust-lightning-bitcoinrpc/blob/master/src/main.rs#L122"}),"Rust example of handling events"))))),Object(r.b)("p",null,"Example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// On startup, start this loop:\nwhile(true) {\n    Event[] channel_manager_events = channel_manager.as_EventsProvider().get_and_clear_pending_events();\n    Event[] chain_monitor_events = chain_watch.as_EventsProvider().get_and_clear_pending_events();\n    Event[] all_events = ArrayUtils.addAll(channel_manager_events, chain_monitor_events);\n    for (Event e: all_events) {\n        <insert code to handle each event>\n    }\n}\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Persist channel manager: in the loop you started in the previous step, add the feature of persisting the channel manager after each event.",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"If the channel manager does not get persisted properly to disk, there is risk of channels force closing the next time LDK starts up. However, in this situation, no funds other than those used to pay force-closed channel fees are at risk of being lost.")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"while (true) {\n    <code from the previous step that handles channel manager events>\n    ...\n    byte[] channel_manager_bytes_to_write = channel_manager.write();\n    <insert code that writes these bytes to disk and/or backups>\n}\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Call the channel manager's ",Object(r.b)("inlineCode",{parentName:"li"},"timer_chan_freshness_every_min()")," every minute",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"What it's used for: the channel manager needs to be told every time a minute passes so that it can broadcast fresh channel updates if needed\nExample:")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"while (true) {\n    <wait 60 seconds>\n    channel_manager.timer_chan_freshness_every_min();\n}\n")),Object(r.b)("h2",{id:"using-ldk"},"Using LDK"),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ",'Opening a channel: see the "Opening a Channel" guide'),Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Closing a channel",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Dependencies: channel manager")))),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"// Cooperative close:\n// Assuming 1 open channel\nbyte[] channel_id = channel_manager.list_channels()[0].get_channel_id();\nResult_NoneAPIErrorZ close_result = channel_manager.close_channel(\n    channel_id);\nassert close_result instanceof Result_NoneAPIErrorZ.Result_NoneAPIErrorZ_OK;\n// Make sure the peer manager processes this new event.\nnio_peer_handler.check_events();\n// LDK should give the transaction broadcaster a closing transaction to broadcast\n// after this\n\n// Force close:\n// Assuming 1 open channel\nbyte[] channel_id = channel_manager.list_channels()[0].get_channel_id();\nResult_NoneAPIErrorZ channel_manager.force_close_channel(channel_id);\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","List open channels")),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),"ChannelDetails[] channels = channel_manager.list_channels();\n")),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Sending/receiving payments ",Object(r.b)("strong",{parentName:"li"},"NOTE: CURRENTLY UNSUPPORTED IN JAVA"),Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Currently unsatisfied dependencies:",Object(r.b)("ol",{parentName:"li"},Object(r.b)("li",{parentName:"ol"},"a way of constructing ",Object(r.b)("inlineCode",{parentName:"li"},"NodeFeatures")," and ",Object(r.b)("inlineCode",{parentName:"li"},"ChannelFeatures")," LDK structs (which should be exposed soon)"),Object(r.b)("li",{parentName:"ol"},"a way to parse invoices (we need to generate bindings for the ",Object(r.b)("inlineCode",{parentName:"li"},"rust-invoices")," crate)"))))),Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","Connect to a peer",Object(r.b)("ul",{parentName:"li"},Object(r.b)("li",{parentName:"ul"},"Dependencies: peer manager, peer's pubkey, peer's host and port")))),Object(r.b)("p",null,"Example:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-java"}),'byte[] peer_pubkey = <peer\'s pubkey bytes>\nint peer_port = 9745;\nSocketAddress peer_socket_addr = new InetSocketAddress("192.168.1.2", peer_port);\nnio_peer_handler.connect(peer_pubkey, peer_socket_address);\n')),Object(r.b)("ul",{className:"contains-task-list"},Object(r.b)("li",Object(a.a)({parentName:"ul"},{className:"task-list-item"}),Object(r.b)("input",Object(a.a)({parentName:"li"},{type:"checkbox",checked:!1,disabled:!0}))," ","List peers\n// TODO")))}b.isMDXComponent=!0},87:function(e,t,n){"use strict";n.d(t,"a",(function(){return h})),n.d(t,"b",(function(){return u}));var a=n(0),i=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?c(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var o=i.a.createContext({}),b=function(e){var t=i.a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},h=function(e){var t=b(e.components);return i.a.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},p=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,c=e.parentName,o=s(e,["components","mdxType","originalType","parentName"]),h=b(n),p=a,u=h["".concat(c,".").concat(p)]||h[p]||d[p]||r;return n?i.a.createElement(u,l(l({ref:t},o),{},{components:n})):i.a.createElement(u,l({ref:t},o))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,c=new Array(r);c[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,c[1]=l;for(var o=2;o<r;o++)c[o]=n[o];return i.a.createElement.apply(null,c)}return i.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);